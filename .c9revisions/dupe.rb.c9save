{"ts":1352635761621,"silentsave":true,"restoring":false,"patch":[[{"diffs":[[1,"require 'find'\nrequire 'mimemagic'\nrequire 'digest/md5'\nrequire 'set'\nrequire 'childprocess'\nrequire 'fileutils'\ninclude FileUtils\n\nTEST_FRAMES = 50\nSTART_TIME = \"00:00:20\"\nSEARCH_DIR = File.expand_path(\"/Users/arnoud/Desktop/dumpert-duplicates/video\")\nTMP_DIR = File.expand_path(\"/Users/arnoud/Desktop/dumpert-duplicates/tmp\")\nTILES_DIR = File.expand_path(TMP_DIR + \"/tiles\")\n\n# Create directories if they don't exist\nmkdir SEARCH_DIR if ! File.directory?(SEARCH_DIR)\nmkdir TMP_DIR if ! File.directory?(TMP_DIR)\n\n# Helper to run command silently and raise exception if didn't run correctly\ndef quietrun(cmd)\n    process = ChildProcess.build(*cmd)\n    process.start\n    begin\n      process.poll_for_exit(60)\n    rescue ChildProcess::TimeoutError\n    end\n    return process.exit_code\nend\n\nDir.chdir(TMP_DIR) do\n  Find.find(SEARCH_DIR) do |filename|\n\n    # Skip if not a file or not video\n    next if ! File.file?(filename)\n    filemime = MimeMagic.by_path(filename)\n    next if ! filemime || ! filemime.video?\n    puts \"*** Analysing: %s\" % filename\n\n    # Get some frames with mplayer\n    print \"\\tMplayer \"\n    if quietrun(['mplayer', '-nosound', '-vo', 'jpeg', '-ss', START_TIME, '-frames', TEST_FRAMES.to_s, filename]) != 0\n      print \"...failed, skipping...\\n\"\n      next\n    end\n\n    # Sanity check\n    if %x(ls *.jpg).split(\"\\n\").length < 1\n      puts \"\\n\\tUnable to create images, skipping...\"\n      next\n    end\n\n    # Create grayscale images\n    print \"|| ImageMagick resize \"\n    quietrun(['mogrify', '-resize', '476x270!', '-colorspace', 'gray', '*.jpg'])\n\n    print \"|| ImageMagick tiles \"\n    Find.find(TMP_DIR) do |frame|\n      quietrun(['convert', '-crop', '119x135', frame, 'tiles/tile%03d.png'])\n      print \"%s\\n\" % frame\n\n      Find.find(TILES_DIR) do |tile|\n        # do Centroid of Gradient Orientations calculation\n        print \" %s\\n\" % tile\n      end\n    end\n\n    exit\n\n    # Delete the images created by mogrify and mplayer\n    #rm(%x(ls *.jpg).split(\"\\n\"))\n\n  end\nend"]],"start1":0,"start2":0,"length1":0,"length2":1995}]],"length":1995}
